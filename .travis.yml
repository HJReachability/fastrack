env:
  global:
    - ROS_DISTRO=indigo
    - ROS_CI_DESKTOP="`lsb_release -cs`"  # e.g. [precise|trusty|...]
    - CI_SOURCE_PATH=$(pwd)
    - ROSINSTALL_FILE=$CI_SOURCE_PATH/dependencies.rosinstall
    - CATKIN_OPTIONS=$CI_SOURCE_PATH/catkin.options
    - ROS_PARALLEL_JOBS='-j4 -l4'
    - PYTHONPATH=$PYTHONPATH:/usr/lib/python2.7/dist-packages:/usr/local/lib/python2.7/dist-packages
    - secure: "MmrmQNIN8MZ3Wyo6QZ+sUCbiWAg5EvBq4eiD4VLJilcOwVoTycuBZjouQWF+eDwH3DKv1Oaocs5jhCWAYXqaEq07e9U/N5T10EZ95lIp5cq/3fVw/lRWmTnnCR4tCgiDvvF41h9w2mOw0lGlEKdfaCEY1hgUWjXtZhY076zS5J/ePiYwyPT1/CK6rVP5CRjtpJMli0zpsPONEc7ANMyKuGo6AH5nbOMsshOY4fnKkBj2BThSB4v5riQ3jRJtNfiwGfzLGMGvPGaR4FOUl5clSv1Jvms9rsdFtaAbm6Rs39WvZlu7/1TM9+m1Jfe5B9NZKPvdW1QkE8NZj9mv0H5syqAycwKpEgewLurX6Mdg0pnpCcPJ4qA7km6hQgqGSIpsMXrndIgpayWEffvHjU/1I0o29KkX0i8jOD7twbdOaydW2RpguMGrG9pHvawGYpSJT7pG73+74L0n9EQRUqulupX7qlKTldi6CcUJoCgvbmaNGa4/FsZ8M9QElxaePCntXgeQpzfo6c+bN3uSXcqqHv1Q1HIEDBqCoSHvWV5WYHAVLsAs5xSqB9RXe4O1FuVopehu27gY7PaxPYeB1ORUdlFHus1DetyhJkB2AG8ocp7wbWgPiHjIe22ZJwNTtHsKAzmS3vVVn5KV0akx0+3mGaRpvtVxvMnzzMsLRw/81vs="

language: cpp

compiler:
  - gcc
  #- clang

os:
  - linux

branches:
  only:
    - master

notifications:
  email: false

before_install:
  - sudo sh -c "echo \"deb http://packages.ros.org/ros/ubuntu $ROS_CI_DESKTOP main\" > /etc/apt/sources.list.d/ros-latest.list"
  - sudo apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-key 421C365BD9FF1F717815A3895523BAEEB01FA116
  - sudo apt-get update
  - sudo apt-get install ros-$ROS_DISTRO-ros-base
  - sudo rosdep init
  - rosdep update
  - sudo apt-get install ros-$ROS_DISTRO-tf
  - source /opt/ros/$ROS_DISTRO/setup.bash
  - openssl aes-256-cbc -K $encrypted_fb7b409fc3b6_key -iv $encrypted_fb7b409fc3b6_iv -in github_deploy_key.enc -out github_deploy_key -d
  - chmod 600 github_deploy_key
  - eval `ssh-agent -s`
  - ssh-add github_deploy_key

install:
  - echo $TRAVIS_OS_NAME
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt-get install --yes build-essential
    doxygen graphviz libgflags-dev libgoogle-glog-dev mercurial cmake libatlas-base-dev libmatio-dev libflann-dev libusb-1.0-0 libusb-1.0-0-dev; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo pip install kitchen; fi

#before_script:
  # Get Eigen. The apt-get version on 12.04 is too old; we need at least 3.1.0.
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir eigen && cd eigen; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then hg clone https://bitbucket.org/eigen/eigen; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd eigen && hg update 3.2; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir build && cd build; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cmake -DCMAKE_BUILD_TYPE=Release ..; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then make -j4; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo make install; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd ../../..; fi

  # Get OMPL v1.2.1 (before they switched to gcc5 dependency).
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir ompl && cd ompl; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then git clone https://github.com/ompl/ompl; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd ompl && git checkout tags/1.2.1; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir build && cd build; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cmake -DCMAKE_BUILD_TYPE=Release ..; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then make -j4; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo make install; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd ../../..; fi

  # Get rosdoc_lite for auto-generating documentation.
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir rosdoc_lite && cd rosdoc_lite; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then git clone https://github.com/ros-infrastructure/rosdoc_lite; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd rosdoc_lite; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo python setup.py install; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd ../..; fi

  # Get crazyflie_clean, since fastrack_crazyflie_demos depends on it.
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mkdir crazyflie_clean && cd crazyflie_clean; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then git clone https://github.com/HJReachability/crazyflie_clean; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd crazyflie_clean/ros; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then catkin_make -j4 && source ./devel/setup.bash; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd ../../..; fi

script:
  - cd ros
  - catkin_make -j4
  - catkin_make run_tests

after_success:
  - cd ..
  - git checkout master
  - rm -rf doc
  - rosdoc_lite ros/src/fastrack
  - ./deploy.sh
